\chapter{BlueBox }

The previous chapter described the motivation and objective for a emergency monitoring device. This chapter will discuss the design consideration for implementing such a system. 
Section \ref{overview} Gives a short overview about the BlueBox system and the signal requirements that the system is designed to monitor and acquire. Relevant design decision and background is also described. 
Section \ref{signal requirements}. Elaborates more on the functional requirements of the system. 
Section \ref{system requirements} Explains some of the design considerations, requirements, and constraints encountered in the design of BlueBox.

\section{Overview}\label{overview}

BlueBox project is very much concerned with providing a very efficient and easy-to-use wearable device with a short setup time while providing the required functionality to record all the required vitals and data. It could save paramedics a lot of their time which they can invest in providing care for patients. BlueBox as mentioned is a wearable, low-power and low cost device that is supposed to be of size 4 cm X 6cm size.

BlueBox records ECG, Body temperature, chest rise(using accelerometer sensors), environment temperature and has two microphones where one is a contact microphone to record the patient's breathing pattern and other is used by paramedics to log the patients condition. The functionality of BlueBox is to record all the data into a persistent storage in the device to be retrieved later for analysis and can be a good indicator understanding patients medical condition and patient's response to emergency treatments before providing further care. Bluebox device is used when patients are in transit to the hospital in an ambulance. The paramedic's logs and the vital signs are synchronized and these synchronized information can provide a better insight about the patients condition from the time of emergency. 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Signal requirements}\label{signal requirements}
\subsection{The Electrocardiogram (ECG)}
The ECG has become a routine part of any complete medical evaluation and has been used as a diagnostic 
test since its discovery over 70 years ago \cite{ecg}. Because electricity is conducted through 
the heart muscle (known as the myocardium), many (but not all) types of damage 
to the heart tissue can be detected with an ECG. The ECG waveform allows one to 
infer information about electrical activity associated with different aspects of a heart 
beat and is therefore of particular value for assessing an individual's health. A summary of the electrical specifications relating to ECG quality is presented in \ref{table:ecg}.

\begin{table}
  \centering
  \begin{tabular}{|l|l|l|}
    \hline
    Specification & Minimum & Target \\
    \hline
    Leads & 4 & 4 \\
    Channel & 1 & 1 \\
    Sampling rate & 250 Hz & 500 Hz \\
    Resolution & 8 bits/sample & 16 bits/sample \\
    \hline
  \end{tabular}
  \caption{ECG signal requirements.}
  \label{table:ecg}
\end{table}

\subsection{Accelerometer}
Signal requirements for the accelerometer are not as constrained as that of the ECG. The most important considerations are the acceleration range, resolution, and sample rate. Acceleration values for acceleration generated by individuals were usually within 4g \cite{wearable_ecg}, so that should be sufficient for obtaining the full range of accelerations. A summary of the specification relating to accelerometer is presented in Table \ref{table:acc}.
\begin{table}[h]
	\centering
	\begin{tabular}{|l |l|l|}
		\hline
		Specification & Minimum & Target \\
		\hline
		Range & $\pm 4g$ & $\pm 8g$ \\
		Resolution & 8 bits & 16 bits\\
		Sampling rate & 4 Hz & 12 Hz \\
		\hline
	\end{tabular}
	\caption{Accelerometer signal requirements.}
	\label{table:acc}
\end{table}

\subsection{Temperature}
The continuous monitoring of patients body temperature is often necessary during induced-hypothermia and general anesthesia, or when employed in the care of infants and premature babies. Intensive care units along with emergency rooms have also adopted patient temperature as a part of vital sign monitoring procedures. There are two different temperature, body temperature and the environment temperature, to be measured and their requirement is driven by its use case. They still share some common considerations like range being measured, resolution and accuracy / reliability. Table \ref{table:tmp} summarizes the specification relating to the temperature. 
\begin{table}[h]
	\centering
	\begin{tabular}{|l|l|l|}
		\hline
		Specification & Body temperature & Environment temperature \\
		\hline
		Range & $0-50 ^{\circ}C$ & $-40-125 ^{\circ}C$ \\
		Resolution & $\pm 0.1$ & $\pm 0.1$\\
		Sampling rate & 2 Hz & 2 Hz \\
		\hline
	\end{tabular}
	\caption{Temperature signal requirements.}
	\label{table:tmp}
\end{table}

\subsection{Audio}
The system is primarily required to record two audio signals. First, Paramedic's log recording feature requires system to record the human voice that has a frequency range between 300 and 3400 Hz. Another audio to record is record the patient's respiration/breathing pattern. Table \ref{table:aud} depicts the specification applicable for both of the audio signals. 

\begin{table}[h]
	\centering
	\begin{tabular}{|l|l|l|}
		\hline
		Specification & Minimum & Target \\
		\hline
		Sampling rate &  8 KHz & 12 KHz \\
		Resolution & 16 bits/sample & 16 bits/sample \\
		\hline
	\end{tabular}
	\caption{Audio signal requirements.}
	\label{table:aud}
\end{table}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{System Requirements}\label{system requirements}
\subsection{Hardware Requirement}

A summary of the desired system specifications are listed in \ref{table:Behavioural_specs}. Both minimum and desired specifications are listed. Further details of each specification are provided in table \ref{table:Behavioural_specs}.
\begin{table}[h]
	\centering
	\begin{tabular}{|l|l|l|}
		\hline
		Specification & Minimum & Target \\
		\hline
		Usability duration & 3 Hours & 4 hours \\
		Memory & 1 GB & 2 GB \\
		Battery & 300 mAH & 300 mAH \\
		\hline
	\end{tabular}
	\caption{BlueBox Behavioural Specification.}
	\label{table:Behavioural_specs}
\end{table}

The signal requirements and the use case provides the system level electrical requirements. To meet the requirement ECG is sampled at 500Hz, two audio channels are sampled at 12000 Hz, Accelerometer is sampled at 12 Hz and two temperatures are sampled at 2Hz. From the target sampling frequency and the resolution of all the signals, audio accounts for 48000 bytes/second, ECG accounts for 2000 bytes of data every second. Accelerometer and temperature data together sums up to 84 bytes per second. Approximatery 50 kilobytes of data is produces every second. For 4 hours 720 MB of data is generated. The system should have enough storage to save the data and also needs have enough processing bandwidth. 

 To record for 4 hours, over 720 MB of space is required(not including file system overhead). The data can either be transmitted to a base station / cell phone or be saved on board. Wirelessly transmitting the data to the base station is power intensive to do continuously and also require the user to have an additional device located nearby all the time. All the data needs to be stored on board, so a high density memory must be used. A micro SD card is well suited to this application. However, writing data to a micro SD card is a power hungry operation and latency of write operations are in hundreds of milliseconds. Most low power Digital signal processors have low on-chip memory, so the system used for the application should have enough memory for buffering data. For a test duration of 4 hours, system should have a battery capacity of several hundreds of milliamp hours is required. A 300 mAH battery, for example, could support an average current of 75 mA for upto 4 hours at a supply voltage of 3.7V. 

\subsection{Firmware Requirement }
The firmware requirements for BlueBox is that it must be able to sample the signals with the required frequency as mentioned in the previous sections and store them. And it must be able to function for 4 hours. Additionally, the bare metal firmware must be able to manage the resource to control the system and to keep the power consumption as low as possible. A low power Digital Signal Processor (DSP) is well suited for this task. The hardware system has to be designed in such a way that DSP expose enough control to the firmware, in order to perform extensive resource and power management. The low-power DSP must have enough communication resource to communicate with the sensors (accelerometer, sd card, audio codec, etc.,), built-in capability for power management (example: configurable power domain, clock gating, power gating, dynamic voltage and frequency scaling), enough debugging opportunities and sufficient on-chip memory for buffering data. 

\subsection {Build-Quality Requirements} 
The most important requirement is that the device be small in size(40 mm X 60 mm), robust, comfortable and comply with the medical guidelines. The device should have defibrillator protection feature. Additionally the device must be water and sweat proof. These requirements for the device must be achieved while maintaining the signal quality requirements discussed in section \ref{signal requirements}.  

\section {Design Requirement and Constraint} 
In general, the requirements associated with a wearable devices places severe restrictions on size and power consumption. Even though battery technology is improving continuously and processors are rapidly improving in terms of power consumption, battery life and battery weight are issues that will have a marked influence on how Wearable medical devices can be used. Medical devices often require real-time processing capabilities, and thus demand high throughput. Power consumption is becoming the limiting factor in the amount of functionality that can be placed in these devices. 

Embedded wearable systems design has been a continuously developing research field. Its complexity actually lies on the fact that an engineer has to take many considerations into account, when designing the systems. There is no system with unlimited resource available, such that the system can perform extremely well without suffering from resource shortage. On the other hand, there is no system that does not follow the user requirements when it tries to accomplish its tasks. In the field of Embedded system designs, engineers are usually constrained by the trade-offs between resource availability and required performance. When it comes to wearable systems, engineers has to take size and power into consideration. Now the engineers are constrained by the trade-offs between resource availability, size, power and performance. This introduces lot of interesting challenges into the design. The characteristics and the potentials of a system are determined by the resources it has. System requirements are always to be fulfilled by the designers. These requirements are to be satisfied if the system is desired to function as it should. With a 
limited amount of resources provided by the system, an engineer has to think carefully about how to use the existing resources in such a way that they can suffice the need to carry out the required tasks. 

In general wearable embedded systems design is a hardware-software codesign problem as the system optimization consist of scheduling and binding \cite{sched_bind}. Scheduling has to be done to meet the deadline of each task that has to be accomplished by the system, while binding has to be done to meet the availability of resource on the system. In other words, scheduling is related to performance and binding is related to resource. For battery operated devices power management becomes the important aspect of functional requirement and software design and it heavily influences schedulability and binding. Functional requirements, including power management, and the way it is planned to be accomplished with the software provides the necessary information about schedulability and binding for the design optimization. Thus requiring a hardware-software codesign. 

\iffalse
In a system, scheduling and binding parameters are determined to optimize the following objectives: 
\begin{description}
	\item[$\bullet$ Area:] Area is related to the amount of resources, e.g. Arithmetic Logic Unit (ALU), DSP accelerators, memory, etc., available on the system.
	\item[$\bullet$ Latency:] Latency is the number of cycles needed to accomplish the task 
	\item[$\bullet$ Battery capacity:] Energy required to accomplish the task for the required duration. 
	\item[$\bullet$ Clock Frequency:] Time interval of a cycle 
	
\end{description} 
\fi
The main problem of such design is to find the most efficient combination of resource usage, optimal performance and battery capacity. The basic rule is to use the available resources as efficient as possible, while trying to achieve, at least, the required performance, i.e. latency or execution time under the power budget. This means all deadlines have to be met with whatever resource existing on the system with minimum power consumption. 


As mentioned in the previous section BlueBox has an size and weight constraint which is considered during the design to optimize the resources of the system to fulfill the constraints. It is required to run for a minimum of four hours on battery and is optimized to have the minimum required resources to acquire, process and store the large number of high frequency signals, mentioned in the previous section, with the required performance.
Battery capacity is directly proportional to its weight as lithium polymer battery tend to have a fixed energy density. The battery consideration is primarily based on its size, weight and heat dissipation. So here the battery capacity is traded off to meet the size and medical guidelines.

The table \ref{table:power_rating} lists the major components used in BlueBox and their power consumption. The best battery that fulfill the size constraint has capacity of 300 mAh @ 3.7 volts. Which is equivalent to 1.11 Wh of energy. The theoretical power consumption of system sums up to 635 mW approximately. At this rate the system will deplete the battery in approximately 100 minutes. 
\begin{table}[h]
	\centering
	\begin{tabular}{|l|l|}
		\hline
		Component & Typical power consumption\\
		\hline
		TMS320C5515 DSP CPU &  100 mW \\
		SDHC card, 50 MHz @ 3.3 V   &  495 mW \\
		AIC3204 Audio Codec  &  21.9 mW \\	
		ADS1292R ECG front end & 1.4 mW \\
		MPU9250 Accelerometer Sensor &  12.21 mW \\
		Environment temperature sensor  &  1 mW \\
		Microphone  & 3.3 mW \\
		Body temperature sensor  &  0.2 mW \\	
		\hline
	\end{tabular}
	\caption{Typical power consumption of components}
	\label{table:power_rating}
\end{table}
\vspace*{-2mm}

From the above calculations it is evident that energy is a scarce resource in this system and it is very important to do rigorous power management to extend the battery life to meet the requirement. So BlueBox with a limited power budget posts the interesting challenge of optimizing the power consumption of the device while meeting all deadlines fulfilling the functionalities with the constrained resources on the system and keep the device running for a minimum of two hours.

The thesis proposes solution to the above mentioned problem statement with structured methodologies for extensive power management through the firmware. The further chapters gives the general context of the hardware and software architecture. Then dives into the proposed power management techniques that tries to solve the problem.

\nomenclature{SD}{ Secure Digital }
\nomenclature{SDHC}{  Secure Digital High Capacity }
\nomenclature{DSP}{  Digital Signal Processor }
\nomenclature{CODEC}{  Coder Decoder }
%%% Local Variables: ***
%%% mode: latex ***
%%% TeX-master: "thesis.tex" ***
%%% End: ***
